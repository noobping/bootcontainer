name: Butane

on:
  push:
    branches:
      - main
      - master
    paths:
      - "butane/**"
      - ".github/workflows/butane.yml"

  workflow_dispatch: {}

concurrency:
  group: iso-continuous
  cancel-in-progress: true

env:
  IMAGE_NAME: ghcr.io/noobping/workstation

jobs:
  build:
    name: Build ${{ matrix.arch }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runs_on: ubuntu-latest
          - arch: arm64
            runs_on: ubuntu-24.04-arm

    runs-on: ${{ matrix.runs_on }}

    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
      - uses: mikefarah/yq@v4.45.1

      - name: Prepare
        run: |
          set -euxo pipefail
          if ! command -v podman >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y podman
          fi
          podman --version

      - name: Ignition
        run: |
          set -euxo pipefail
          yq ea '. as $item ireduce ({}; . *+ $item)' butane/base.yml butane/setup.yml > butane/setup.bu
          yq ea '. as $item ireduce ({}; . *+ $item)' butane/base.yml butane/workstation.yml > butane/workstation.bu

          podman run --rm \
            -v "$PWD:/work:Z" -w /work \
            quay.io/coreos/butane:release \
            --pretty --strict --files-dir . butane/setup.bu > setup.ign

          podman run --rm \
            -v "$PWD:/work:Z" -w /work \
            quay.io/coreos/butane:release \
            --pretty --strict butane/workstation.bu > workstation.ign

      - name: Configure
        run: |
          set -euxo pipefail
          test -f butane/iso-config.toml.in
          test -f butane/detect-device.sh

          python3 - <<'PY'
          from pathlib import Path
          tmpl = Path("butane/iso-config.toml.in").read_text()
          script = Path("butane/detect-device.sh").read_text().rstrip("\n")
          out = tmpl.replace("__DETECT_DEVICE_SCRIPT__", script)
          Path("iso-config.toml").write_text(out)
          print("Wrote iso-config.toml")
          PY

      - name: Build
        id: build_iso
        uses: osbuild/bootc-image-builder-action@v0.0.2
        with:
          config-file: ./iso-config.toml
          image: ${{ env.IMAGE_NAME }}:${{ matrix.arch }}
          rootfs: xfs
          types: |
            anaconda-iso

      - name: Collect
        run: |
          set -euxo pipefail
          ISO_IN="${{ steps.build_iso.outputs.anaconda-iso-output-path }}"
          OUT="workstation-installer-$(uname -m).iso"
          cp -v "$ISO_IN" "$OUT"
          sha256sum "$OUT" | tee "${OUT}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: workstation-installer-${{ matrix.arch }}
          path: |
            workstation-installer-${{ matrix.iso_arch }}.iso
            workstation-installer-${{ matrix.iso_arch }}.iso.sha256
          if-no-files-found: error
          retention-days: 14

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Show files
        run: |
          set -euxo pipefail
          find dist -type f -maxdepth 3 -print -exec ls -lah {} \;

      - name: Release artifacts
        uses: ncipollo/release-action@v1
        with:
          tag: continuous
          name: Continuous
          allowUpdates: true
          replacesArtifacts: true
          prerelease: false
          makeLatest: true
          artifacts: "dist/**/*.iso,dist/**/*.sha256"
          generateReleaseNotes: false
          body: |
            This release is automatically updated.
